---
import BaseHead from "@/components/BaseHead.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import CardStackable from "@/components/CardStackable.astro";
import CardWrapper from "@/components/CardWrapper.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "@/consts";
import { getCollection } from "astro:content";
import CollaborateCard from "@/components/CollaborateCard.astro";
import BlogCard from "@/components/BlogCard.astro";

const featuredBlogs = await getCollection("blog", ({ data }) => {
  return data.featured === true;
});
---

<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      /* Ticker items inherit color from inline styles set by JS */
      .ticker-track .ticker-item,
      .ticker-track .ticker-divider {
        color: inherit;
      }
      .ticker-divider {
        opacity: 0.5;
      }
      @keyframes live-pulse {
        0% {
          opacity: 0.2;
          transform: scale(0.85);
        }
        50% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0.2;
          transform: scale(0.85);
        }
      }
      .live-dot {
        animation: live-pulse 1.2s ease-in-out infinite;
      }
    </style>
  </head>
  <body>
    <section class="my-8 max-w-[1240px] mx-auto px-4">
      <Header />
      <div class="w-full">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-stretch">
          <CardWrapper class="md:col-span-3">
            <img
              src="/images/headshot.png"
              loading="lazy"
              width="100"
              alt="Kevin Herrera headshot"
              class="rounded-full"
              height="100"
            />
            <div class="mt-6">
              <h1 class="text-5xl font-bold dark:text-darkText">
                Meet Kevin, a code ninja crafting epic software at <span
                  class="cloudflare-orange"
                >
                  <a
                    href="https://www.cloudflare.com"
                    target="_blank"
                    rel="noreferrer noopener"
                    >Cloudflare.</a
                  >
                </span>
              </h1>
            </div>
          </CardWrapper>
          <div class="md:col-span-2">
            <CollaborateCard />
          </div>
        </div>
        <CardWrapper
          class="news-ticker-container col-span-5 row-start-2 py-4 px-8 my-4"
        >
          <div
            class="ticker flex items-center gap-4"
            data-endpoint="/api/ticker.json"
          >
            <div
              class="shrink-0 flex items-center gap-2 text-xs font-semibold uppercase tracking-widest text-gray-500 dark:text-darkTextSecondary"
            >
              <span
                class="live-dot inline-block h-2.5 w-2.5 rounded-full bg-red-600 dark:bg-darkGreen"
              ></span>
              <span>Live</span>
            </div>
            <div class="relative w-full overflow-hidden">
              <div
                class="ticker-track flex items-center whitespace-nowrap text-sm md:text-base"
              >
                <span class="text-gray-500 dark:text-darkTextSecondary">Loading ticker...</span>
              </div>
            </div>
          </div>
          <script is:inline>
            // Namespace for app utilities
            window.__herrerake = window.__herrerake || {};

            function initTicker() {
              // Clean up previous instance if exists
              if (window.__herrerake.tickerCleanup) {
                window.__herrerake.tickerCleanup();
              }

              const tickerRoot = document.querySelector(
                ".news-ticker-container [data-endpoint]",
              );
              const track = tickerRoot?.querySelector(".ticker-track");
              if (!tickerRoot || !track) return;

              const endpoint = tickerRoot.getAttribute("data-endpoint");
              let lastDataHash = "";
              let cachedItems = null;
              let scrollPos = 0;
              let halfWidth = 0;
              let animationId = null;
              let intervalId = null;
              const speed = 50; // pixels per second

              // Get colors from CSS custom properties (single source of truth in global.css)
              const getColors = () => {
                const styles = getComputedStyle(document.documentElement);
                return {
                  label: styles.getPropertyValue("--body-text").trim(),
                  value: styles.getPropertyValue("--text-secondary").trim(),
                  positive: styles.getPropertyValue("--color-positive").trim(),
                  negative: styles.getPropertyValue("--color-negative").trim(),
                  divider: styles.getPropertyValue("--color-divider").trim(),
                };
              };

              const formatChange = (value) => {
                if (typeof value !== "number" || Number.isNaN(value)) return "";
                const sign = value > 0 ? "+" : "";
                return `${sign}${value.toFixed(2)}%`;
              };

              const hashData = (items) => JSON.stringify(items);

              const buildContent = (items) => {
                const fragment = document.createDocumentFragment();
                const colors = getColors();

                items.forEach((item) => {
                  const wrapper = document.createElement("span");
                  wrapper.className = "ticker-item inline-flex items-center gap-2";

                  const label = document.createElement("span");
                  label.className = "font-semibold";
                  label.style.color = colors.label;
                  label.textContent = item.label;
                  wrapper.appendChild(label);

                  const value = document.createElement("span");
                  value.style.color = colors.value;
                  value.textContent = item.value;
                  wrapper.appendChild(value);

                  if (typeof item.change === "number") {
                    const change = document.createElement("span");
                    change.style.color = item.change >= 0 ? colors.positive : colors.negative;
                    change.textContent = formatChange(item.change);
                    wrapper.appendChild(change);
                  }

                  fragment.appendChild(wrapper);

                  const divider = document.createElement("span");
                  divider.className = "ticker-divider mx-4";
                  divider.style.color = colors.divider;
                  divider.textContent = "|";
                  fragment.appendChild(divider);
                });
                return fragment;
              };

              let lastTime = 0;
              const animate = (timestamp) => {
                if (!lastTime) lastTime = timestamp;
                const delta = timestamp - lastTime;
                lastTime = timestamp;

                scrollPos += (speed * delta) / 1000;

                // Reset seamlessly when first half scrolls out
                if (scrollPos >= halfWidth) {
                  scrollPos -= halfWidth;
                }

                track.style.transform = `translateX(-${scrollPos}px)`;
                animationId = requestAnimationFrame(animate);
              };

              const startAnimation = () => {
                if (animationId) cancelAnimationFrame(animationId);
                lastTime = 0;
                // Don't reset scrollPos to maintain position during theme change
                halfWidth = track.scrollWidth / 2;
                animationId = requestAnimationFrame(animate);
              };

              const renderItems = (items, force = false, preserveScroll = false) => {
                const newHash = hashData(items);
                if (!force && newHash === lastDataHash) return;
                lastDataHash = newHash;
                cachedItems = items;

                if (animationId) cancelAnimationFrame(animationId);
                track.style.transform = "";
                track.innerHTML = "";

                if (!items?.length) {
                  const colors = getColors();
                  track.innerHTML =
                    `<span style="color: ${colors.value}">No live updates available.</span>`;
                  return;
                }

                // Build content twice for seamless loop
                track.appendChild(buildContent(items));
                track.appendChild(buildContent(items));

                // Start smooth scrolling
                if (!preserveScroll) {
                  scrollPos = 0;
                }
                requestAnimationFrame(() => startAnimation());
              };

              const loadTicker = async (force = false) => {
                try {
                  const response = await fetch(endpoint, { cache: "no-store" });
                  if (!response.ok) throw new Error("Ticker fetch failed");
                  const data = await response.json();
                  renderItems(data.items, force);
                } catch (error) {
                  renderItems(
                    [{ label: "Ticker", value: "Unavailable" }],
                    force,
                  );
                }
              };

              // Handle theme changes - re-render with current data
              const handleThemeChange = () => {
                if (cachedItems) {
                  renderItems(cachedItems, true, true);
                }
              };

              loadTicker(true);
              intervalId = setInterval(() => loadTicker(false), 60_000);

              // Listen for theme changes
              window.addEventListener("themechange", handleThemeChange);

              // Store cleanup function in namespace
              window.__herrerake.tickerCleanup = () => {
                if (animationId) cancelAnimationFrame(animationId);
                if (intervalId) clearInterval(intervalId);
                window.removeEventListener("themechange", handleThemeChange);
              };
            }

            // Run on initial load and after View Transitions
            initTicker();
            document.addEventListener("astro:page-load", initTicker);
          </script>
        </CardWrapper>
        <div class="grid md:grid-cols-3 grid-rows-1 gap-4">
          <CardWrapper>
            <span class="text-8xl">ü§òüèæ</span>
            <h3 class="text-5xl font-bold mt-6 dark:text-darkText">
              Based in <br /> Austin, Texas <br /> GMT-6
            </h3>
          </CardWrapper>
          <CardWrapper class="md:col-span-2">
            <p class="text-3xl font-bold dark:text-darkTextSecondary">
              I design build and deliver AI-assisted systems that automate
              repetitive human workflows. Right now I'm specifically focused on
              creating an agent that takes data from Google docs into
              Contentful. I also make Arepas ü´ì
            </p>
          </CardWrapper>
        </div>
      </div>
      <div class="w-full my-4">
        <div class="grid md:grid-cols-2 grid-rows-1 gap-4">
          <div class="single-card-container">
            <BlogCard blog={featuredBlogs[0]} className="h-full" />
          </div>
          <div class="flex flex-col justify-between items-start gap-4">
            {
              featuredBlogs.slice(1, 4).map((post) => (
                <CardStackable blog={post} />
              ))
            }
            <a
              href="/blog"
              class="text-center py-3 px-16 rounded-lg bg-bluePrimary text-white text-base font-medium flex items-center space-x-1 dark:bg-darkAccent dark:text-darkBg"
            >
              <span>View all blogs</span>
              <svg
                width="11"
                height="11"
                viewBox="0 0 11 11"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M10.75 1C10.75 0.585786 10.4142 0.25 10 0.25L3.25 0.25C2.83579 0.25 2.5 0.585786 2.5 1C2.5 1.41421 2.83579 1.75 3.25 1.75L9.25 1.75L9.25 7.75C9.25 8.16421 9.58579 8.5 10 8.5C10.4142 8.5 10.75 8.16421 10.75 7.75L10.75 1ZM9.46967 0.46967L0.46967 9.46967L1.53033 10.5303L10.5303 1.53033L9.46967 0.46967Z"
                  fill="white"></path>
              </svg>
            </a>
          </div>
        </div>
      </div>
      <Footer />
    </section>
  </body>
</html>
