---
import BaseHead from "@/components/BaseHead.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "@/consts";
import { getCollection } from "astro:content";
import CardWrapper from "@/components/CardWrapper.astro";
import BlogCard from "@/components/BlogCard.astro";
import { getTagLabel } from "@/data/tags";

const allBlogs = await getCollection("blog");
allBlogs.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const filter = Astro.url.searchParams.get("filter") || "all";

// Build tag counts from posts that actually use each tag
const tagCounts = new Map<string, number>();
for (const blog of allBlogs) {
  for (const tag of blog.data.tags) {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  }
}

const blogs = filter === "all"
  ? allBlogs
  : allBlogs.filter((blog) => blog.data.tags.includes(filter));
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <section class="my-8 max-w-[1240px] mx-auto px-4">
      <Header />
      <main>
        <CardWrapper class="mb-4">
          <div class="">
            <h1 class="text-6xl px-0 font-bold text-bluePrimary dark:text-darkText -ml-1">Blog</h1>
          </div>
          <div class="flex mt-6">
            <div>
              <h3 class="text-bluePrimary text-xl font-bold dark:text-darkText">Filter</h3>
              <div class="flex flex-wrap gap-2 mt-2">
                <form>
                  <button
                    type="submit"
                    class={`${filter === "all" ? "text-white" : "text-textPrimary dark:text-darkTextSecondary"} text-sm border-[#e0e0e0] dark:border-darkBorder ${filter === "all" ? "bg-bluePrimary dark:bg-darkAccent dark:text-darkBg" : "bg-[#eaeaea] dark:bg-darkBg"} rounded-full px-4 py-1.5`}
                  >
                    All - {allBlogs.length}
                  </button>
                </form>
                {
                  [...tagCounts.entries()].map(([tag, count]) => (
                    <form>
                      <input type="hidden" name="filter" value={tag} />
                      <button
                        type="submit"
                        class={`${filter === tag ? "text-white" : "text-textPrimary dark:text-darkTextSecondary"} text-sm border-[#e0e0e0] dark:border-darkBorder ${filter === tag ? "bg-bluePrimary dark:bg-darkAccent dark:text-darkBg" : "bg-[#eaeaea] dark:bg-darkBg"} rounded-full px-4 py-1.5`}
                      >
                        {getTagLabel(tag)} - {count}
                      </button>
                    </form>
                  ))
                }
              </div>
            </div>
          </div>
        </CardWrapper>
        <div class="grid sm:grid-cols-2 mt-4 gap-8">
          {blogs.map((blog) => <BlogCard blog={blog} />)}
        </div>
      </main>
      <Footer />
    </section>
  </body>
</html>
